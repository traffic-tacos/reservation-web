---
description: API Gateway μ»΄ν¬λ„νΈ μƒμ„Έ κΈ°μ  μ”κµ¬μ‚¬ν•­ λ° κµ¬ν„ κ°€μ΄λ“
alwaysApply: true
---

# API Gateway: κ³ μ„±λ¥ BFF (Backend for Frontend)

## π― μ»΄ν¬λ„νΈ μ—­ν• 
EKS ν™κ²½μ—μ„ λ™μ‘ν•λ” κ³ μ„±λ¥ BFFλ΅μ„ μ™Έλ¶€ ν΄λΌμ΄μ–ΈνΈμ λ‹¨μΌ μ§„μ…μ  μ—­ν• μ„ μν–‰

## π“‹ μ»¨ν…μ¤νΈ
- **μ‹μ¤ν… λ©ν‘**: 30k RPS μ μ… νΈλν”½ μ•μ • μ²λ¦¬
- **μ£Όμ” μ±…μ„**:
  - JWT κ²€μ¦ (OIDC/Cognito μ—°λ™)
  - μ”μ²­ ν‘μ¤€ν™” λ° μ§‘κ³„
  - Idempotency-Key κ²€μ¦ λ° κ΄€λ¦¬
  - λ°±μ—”λ“ μ„λΉ„μ¤λ΅μ REST ν¬μ›λ”©
  - μ„ νƒμ  μΊμ‹± λ° μ”μ²­ ν•©μ„±

## π› οΈ κΈ°μ  μ¤νƒ

### Core Framework
- **μ–Έμ–΄**: Go 1.22+
- **λ°νƒ€μ„**: Linux ARM64 (Graviton)
- **μ›Ή ν”„λ μ„μ›ν¬**: Fiber v2
- **λ¨λ“ μ‹μ¤ν…**: Go Modules

### μΈμ¦ & λ³΄μ•
- **JWT λΌμ΄λΈλ¬λ¦¬**: lestrrat-go/jwx v2
- **JWK μΊμ‹**: Redis κΈ°λ° (10λ¶„ TTL)
- **μ‹νλ¦¬ν‹° ν—¤λ”**: μλ™ μ¶”κ°€ (CSP, HSTS, X-Frame-Options)

### λ°μ΄ν„° μ €μ¥μ†
- **μΊμ‹**: Redis (ElastiCache)
  - λ μ΄νΈ λ¦¬λ―Έν… μΉ΄μ΄ν„°
  - Idempotency ν‚¤ μ €μ¥
  - JWK μΊμ‹
- **λ©”νΈλ¦­**: Prometheus ν΄λΌμ΄μ–ΈνΈ
- **νΈλ μ΄μ‹±**: OpenTelemetry OTLP

### HTTP ν΄λΌμ΄μ–ΈνΈ
- **ν‘μ¤€ λΌμ΄λΈλ¬λ¦¬**: net/http
- **μ»¤μ¤ν…€ νΈλμ¤ν¬νΈ**:
  - νƒ€μ„μ•„μ›ƒ μ„¤μ • (600ms λ°±μ—”λ“ νΈμ¶)
  - μ»¤λ„¥μ… ν’€ (MaxIdleConns: 2000)
  - μ¬μ‹λ„ λ΅μ§ (λ©±λ“± μ”μ²­λ§)

## π—οΈ μ•„ν‚¤ν…μ² μ„¤κ³„

### ν”„λ΅μ νΈ κµ¬μ΅°
```
cmd/gateway/main.go                    # μ• ν”λ¦¬μΌ€μ΄μ… μ§„μ…μ 
internal/
β”β”€β”€ config/config.go                  # ν™κ²½μ„¤μ • κ΄€λ¦¬
β”β”€β”€ logging/logger.go                 # κµ¬μ΅°ν™” λ΅κΉ…
β”β”€β”€ metrics/metrics.go                # Prometheus λ©”νΈλ¦­
β”β”€β”€ middleware/                       # λ―Έλ“¤μ›¨μ–΄ μ»΄ν¬λ„νΈ
β”‚   β”β”€β”€ auth.go                      # JWT μΈμ¦
β”‚   β”β”€β”€ idempotency.go              # λ©±λ“±μ„± κ΄€λ¦¬
β”‚   β”β”€β”€ ratelimit.go               # λ μ΄νΈ λ¦¬λ―Έν…
β”‚   β”β”€β”€ tracing.go                 # λ¶„μ‚° μ¶”μ 
β”‚   β””β”€β”€ manager.go                 # λ―Έλ“¤μ›¨μ–΄ κ΄€λ¦¬μ
β”β”€β”€ clients/                        # λ°±μ—”λ“ ν΄λΌμ΄μ–ΈνΈ
β”‚   β”β”€β”€ reservation.go             # μμ•½ API ν΄λΌμ΄μ–ΈνΈ
β”‚   β””β”€β”€ payment.go                # κ²°μ  API ν΄λΌμ΄μ–ΈνΈ
β””β”€β”€ routes/                         # API ν•Έλ“¤λ¬
    β”β”€β”€ queue.go                   # λ€κΈ°μ—΄ μ—”λ“ν¬μΈνΈ
    β”β”€β”€ reservation.go            # μμ•½ μ—”λ“ν¬μΈνΈ
    β”β”€β”€ payment.go               # κ²°μ  μ—”λ“ν¬μΈνΈ
    β””β”€β”€ routes.go                # λΌμ°νΈ μ„¤μ •
```

### μ„¤μ • κ΄€λ¦¬
- **ν™κ²½λ³€μ κΈ°λ°**: 12-factor μ•± μ¤€μ
- **ν•„μ λ³€μ κ²€μ¦**: λ¶€ν… μ‹μ  μ ν¨μ„± κ²€μ‚¬
- **κΈ°λ³Έκ°’ μ κ³µ**: κ°λ° νΈμμ„± κ³ λ ¤

## π” API μ—”λ“ν¬μΈνΈ

### κ³µκ° μ—”λ“ν¬μΈνΈ
```yaml
POST /api/v1/queue/join        # λ€κΈ°μ—΄ μ°Έμ—¬ (μµλ… ν—μ©)
GET  /api/v1/queue/status      # λ€κΈ°μ—΄ μƒνƒ μ΅°ν
POST /api/v1/reservations      # μμ•½ μƒμ„± (λ©±λ“±μ„± ν•„μ)
POST /api/v1/reservations/{id}/cancel  # μμ•½ μ·¨μ†
POST /api/v1/reservations/{id}/confirm # μμ•½ ν™•μ •
POST /api/v1/payment/intent    # κ²°μ  μΈν…νΈ μƒμ„±
GET  /healthz                  # ν—¬μ¤ μ²΄ν¬
GET  /readyz                   # readiness μ²΄ν¬
GET  /version                  # λ²„μ „ μ •λ³΄
GET  /metrics                  # Prometheus λ©”νΈλ¦­
```

### μΈμ¦ μ”κµ¬μ‚¬ν•­
- **Bearer ν† ν°**: `Authorization: Bearer <JWT>`
- **JWK κ²€μ¦**: JWKS μ—”λ“ν¬μΈνΈ κΈ°λ° λ™μ  κ²€μ¦
- **ν΄λ μ„ κ²€μ¦**: aud, iss, exp ν•„μ κ²€μ¦
- **μµλ… μ—”λ“ν¬μΈνΈ**: ν™”μ΄νΈλ¦¬μ¤νΈ κΈ°λ° μμ™Έ μ²λ¦¬

### λ©±λ“±μ„± κ΄€λ¦¬
- **ν—¤λ” μ”κµ¬**: `Idempotency-Key: <uuid-v4>`
- **μ €μ¥μ†**: Redis (TTL: 5λ¶„)
- **μ¶©λ μ²λ¦¬**: λ™μΌ ν‚¤ + λ‹¤λ¥Έ λ°”λ”” = 409 μ—λ¬
- **μ‘λ‹µ μΊμ‹**: μ„±κ³µ μ‘λ‹µ μ„μ‹ μ €μ¥

### λ μ΄νΈ λ¦¬λ―Έν…
- **μ•κ³ λ¦¬μ¦**: ν† ν° λ²„ν‚· (Redis Lua κΈ°λ°)
- **μ ν•**: IP/μ‚¬μ©μλ³„ 50 RPS, λ²„μ¤νΈ 100
- **μ‘λ‹µ**: 429 + Retry-After ν—¤λ”
- **μμ™Έ**: ν—¬μ¤μ²΄ν¬ μ—”λ“ν¬μΈνΈ

## π”„ λ°±μ—”λ“ μ—°λ™

### Reservation API (Spring Boot)
```yaml
base_url: http://reservation-api.tickets-api.svc.cluster.local:8010
timeout: 600ms
mapping:
  /api/v1/reservations/* β†’ /v1/reservations/*
headers:
  - x-request-id
  - traceparent
  - authorization
```

### Payment API (Go)
```yaml
base_url: http://payment-sim-api.tickets-api.svc.cluster.local:8030
timeout: 400ms
mapping:
  /api/v1/payment/* β†’ /v1/sim/*
```

## π“ κ΄€μΈ΅μ„± (Observability)

### λ©”νΈλ¦­ μμ§‘
```yaml
http_server_requests_total{method, route, status_code}
http_server_requests_duration_seconds_bucket{method, route, status_code}
backend_call_duration_seconds{service, method, status_code}
ratelimit_dropped_total{}
idempotency_hits_total{type}  # "hit" or "miss"
```

### κµ¬μ΅°ν™” λ΅κΉ…
```json
{
  "ts": "2024-01-01T12:00:00Z",
  "level": "info",
  "msg": "request_completed",
  "http": {
    "method": "POST",
    "route": "/api/v1/reservations",
    "status": 201
  },
  "latency_ms": 45.2,
  "trace_id": "abc123...",
  "user_id": "user456..."
}
```

### νΈλ μ΄μ‹±
- **μƒν”λ§**: κΈ°λ³Έ 10%, μμ•½ κ²½λ΅λ” 100%
- **μ»¨ν…μ¤νΈ μ „ν**: W3C Trace Context
- **λ°±μ—”λ“ μ¶”μ **: λ¨λ“  μ•„μ›ƒλ°”μ΄λ“ μ”μ²­μ— ν—¤λ” μ£Όμ…

## β΅ μ„±λ¥ μ”κµ¬μ‚¬ν•­

### λ©ν‘ μ§€ν‘
- **P95 μ§€μ—°μ‹κ°„**: < 50ms (λ°±μ—”λ“ μ μ™Έ)
- **μ—λ¬μ¨**: < 0.5%
- **429 λΉ„μ¨**: β‰¤ 1% (Admission μ»¨νΈλ΅¤)

### μµμ ν™” ν¬μΈνΈ
- **GOMAXPROCS**: CPU μ½”μ–΄ μμ— λ§μ¶¤
- **HTTP/1.1 μ°μ„ **: Envoy/ALB νΈν™μ„±
- **μ»¤λ„¥μ… ν’€**: MaxIdleConns=2000, IdlePerHost=1000
- **λ©”λ¨λ¦¬ κ΄€λ¦¬**: ReadOnlyRootFilesystem

### HPA κ³ λ ¤μ‚¬ν•­
- **CPU κΈ°λ°**: 60% utilization
- **λ©”λ¨λ¦¬ κΈ°λ°**: 70% utilization
- **μ»¤μ¤ν…€ λ©”νΈλ¦­**: RPS κΈ°λ° μ¤μΌ€μΌλ§

## π€ λ°°ν¬ μ”κµ¬μ‚¬ν•­

### Kubernetes λ¦¬μ†μ¤
```yaml
requests:
  cpu: 200m
  memory: 256Mi
limits:
  cpu: 1000m
  memory: 512Mi
```

### λ³΄μ• μ»¨ν…μ¤νΈ
```yaml
runAsNonRoot: true
runAsUser: 10001
runAsGroup: 10001
readOnlyRootFilesystem: true
capabilities:
  drop: [ALL]
```

### λ„¤νΈμ›ν¬ μ •μ±…
- **μΈκ·Έλ μ¤**: Gateway API μ»¨νΈλ΅¤λ¬λ§ ν—μ©
- **μ΄κ·Έλ μ¤**: λ°±μ—”λ“ μ„λΉ„μ¤ + OTLP μ½λ ‰ν„°λ§ ν—μ©

## π§ ν…μ¤νΈ μ”κµ¬μ‚¬ν•­

### μ λ‹› ν…μ¤νΈ
- **μ»¤λ²„λ¦¬μ§€**: 80% μ΄μƒ λ©ν‘
- **ν•Έλ“¤λ¬λ³„**: λ―Έλ“¤μ›¨μ–΄, ν΄λΌμ΄μ–ΈνΈ, λΌμ°νΈλ³„ ν…μ¤νΈ
- **λ¨ν‚Ή**: λ°±μ—”λ“ μ„λΉ„μ¤, Redis, JWKS λ¨ν‚Ή

### ν†µν•© ν…μ¤νΈ
- **API κ³„μ•½**: OpenAPI μ¤ν™ κΈ°λ° κ²€μ¦
- **λ¶€ν• ν…μ¤νΈ**: k6 κΈ°λ° μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ
- **E2E ν…μ¤νΈ**: μ „μ²΄ ν”λ΅μ° κ²€μ¦

### μ„±λ¥ ν…μ¤νΈ
```javascript
// k6 μ¤ν¬λ¦½νΈ κµ¬μ΅°
export const options = {
  scenarios: {
    load_test: {
      stages: [
        { duration: '1m', target: 500 },
        { duration: '3m', target: 2000 },
        { duration: '5m', target: 5000 },
      ]
    }
  },
  thresholds: {
    'http_req_duration{status:200}': ['p(95)<500'],
    'http_req_failed': ['rate<0.05'],
  }
}
```

## π“‹ κµ¬ν„ μ²΄ν¬λ¦¬μ¤νΈ

### ν•„μ κΈ°λ¥
- [ ] JWT μΈμ¦ λ―Έλ“¤μ›¨μ–΄
- [ ] Idempotency ν‚¤ κ²€μ¦
- [ ] Redis κΈ°λ° λ μ΄νΈ λ¦¬λ―Έν…
- [ ] λ°±μ—”λ“ API ν΄λΌμ΄μ–ΈνΈ
- [ ] κµ¬μ΅°ν™”λ λ΅κΉ…
- [ ] Prometheus λ©”νΈλ¦­
- [ ] OpenTelemetry νΈλ μ΄μ‹±
- [ ] ν—¬μ¤μ²΄ν¬ μ—”λ“ν¬μΈνΈ

### μ„±λ¥ μµμ ν™”
- [ ] HTTP ν΄λΌμ΄μ–ΈνΈ νλ‹
- [ ] λ©”λ¨λ¦¬ λ„μ λ°©μ§€
- [ ] Graceful shutdown
- [ ] μ»¨ν…μ¤νΈ νƒ€μ„μ•„μ›ƒ

### λ³΄μ• κ°•ν™”
- [ ] λ³΄μ• ν—¤λ” μ¶”κ°€
- [ ] μ…λ ¥ κ²€μ¦ κ°•ν™”
- [ ] μ—λ¬ μ •λ³΄ λ…Έμ¶ μ ν•
- [ ] OWASP Top 10 λ€μ‘

---

*API Gateway μ»΄ν¬λ„νΈμ μƒμ„Έν• κΈ°μ  μ”κµ¬μ‚¬ν•­ λ° κµ¬ν„ κ°€μ΄λ“μ…λ‹λ‹¤.*